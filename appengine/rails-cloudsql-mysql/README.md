# Rails using Cloud SQL for MySQL

This sample can be generated by following along with the associated [tutorial][using_cloudsql_mysql] documentation.

## Setup

Before you can run or deploy the sample, you will need to do the following:

1. Create a [Second Generation Cloud SQL][gen] instance. You can do this from
the [Cloud Console][console] or via the [Cloud SDK][sdk].

1. Create a [Service Account][service] for your project. You will use this
service account to connect to your Cloud SQL instance locally using the Cloud
SQL Proxy.

1. Download and install the [Cloud SQL Proxy][proxy].

1. [Start the proxy][start] to allow connecting to your instance from your local
machine:

        cloud_sql_proxy \
            -dir /cloudsql \
            -instances=[YOUR_INSTANCE_CONNECTION_NAME] \
            -credential_file=PATH_TO_YOUR_SERVICE_ACCOUNT_JSON

    where `[YOUR_INSTANCE_CONNECTION_NAME]` is the connection name of your
    instance on its Overview page in the Google Cloud Platform Console, or use
    `[YOUR_PROJECT_ID]:[YOUR_REGION]:[YOUR_INSTANCE_NAME]`.

1. Use the MySQL command line tools (or a management tool of your choice) to
create a [new user][user] and [database][database] for your application:

        mysql --socket [YOUR_SOCKET_PATH] -u root -p
          mysql> create database YOUR_DATABASE;
          mysql> create user 'YOUR_USER'@'%' identified by 'PASSWORD';
          mysql> grant all on YOUR_DATABASE.* to 'YOUR_USER'@'%';

    where `[YOUR_SOCKET_PATH]` is that socket opened by the proxy. This path was
    printed to the console when you started the proxy, and is of the format:
    `/cloudsql/[YOUR_PROJECT_ID]:[YOUR_REGION]:[YOUR_INSTANCE_NAME]`.

1. Update `config/database.yml` with values for `[YOUR_MYSQL_USERNAME]`,
`[YOUR_MYSQL_PASSWORD]`, and `[YOUR_INSTANCE_CONNECTION_NAME]`.
This allows the app to connect to your Cloud SQL instance through the Cloud SQL
Proxy. Note: The Cloud SQL Proxy is automatically setup when an app is deployed
to Google App Engine flexible environment.

1. Update the values in `app.yaml` with your instance configuration and a secret
    key.

1. Install dependencies

    bundle install

1. Setup production database

    RAILS_ENV=production bundle exec rails db:migrate

## Run locally

Deploy the Rails sample by using the following command:

    RAILS_ENV=production bundle exec rails server

Note: Be sure to run the Cloud SQL Proxy before running the Rails server.

## Deployment

After following the steps listed above, ignoring the Cloud SQL Proxy. You can
deploy by using the following command:

    gcloud app deploy

[mysql]: https://cloud.google.com/sql/docs/mysql
[flexible]: https://cloud.google.com/appengine
[gen]: https://cloud.google.com/sql/docs/create-instance
[console]: https://console.developers.google.com
[sdk]: https://cloud.google.com/sdk
[service]: https://cloud.google.com/sql/docs/external#createServiceAccount
[proxy]: https://cloud.google.com/sql/docs/external#install
[start]: https://cloud.google.com/sql/docs/external#6_start_the_proxy
[user]: https://cloud.google.com/sql/docs/create-user
[database]: https://cloud.google.com/sql/docs/create-database
[using_cloudsql_mysql]: https://cloud.google.com/ruby/rails/using-cloudsql


